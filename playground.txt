<!-- STEP 1 -->
<div id="form-step-settings-1" class="container-fluid g-3 p-0">

  <!-- Search & Add Button -->
  <div class="d-flex align-items-center mb-0 sticky-top p-2" style="z-index: 10; top: 0;">
    <!-- Search Box -->
    <div class="flex-grow-1 me-2">
      <input type="text"
             id="searchPlantilla"
             class="form-control form-control-sm rounded-pill"
             placeholder="ðŸ” Search plantilla by description or code...">
    </div>
    <!-- Buttons -->
    <div>
      <button type="button" class="btn btn-primary rounded-pill px-3" id="addPlantillaBtn">
        <i class="uil uil-user-plus"></i>
      </button>
      <button type="button" class="btn btn-primary rounded-pill px-3" id="nextBtnPL">
        <i class="uil uil-arrow-right"></i>
      </button>
    </div>
  </div>

  <!-- Plantilla Form -->
  <form id="plantillaPositionForm" class="mb-3 p-2 border-0 d-none">
    <div class="row g-2">
      <input type="hidden" class="form-control form-control-sm" id="pp_pp_id" name="pp_pp_id">
      <div class="col-md-6">
        <label for="pp_pp_desc" class="form-label">Description</label>
        <input type="text" class="form-control form-control-sm" id="pp_pp_desc" name="pp_pp_desc" required>
      </div>
      <div class="col-md-6">
        <label for="pp_pp_code" class="form-label">Code</label>
        <input type="text" class="form-control form-control-sm" id="pp_pp_code" name="pp_pp_code" required>
      </div>
      <div class="col-md-4">
        <label for="pp_pp_rank" class="form-label">Rank</label>
        <input type="number" class="form-control form-control-sm" id="pp_pp_rank" name="pp_pp_rank" readonly>
      </div>
      <div class="col-md-4">
        <label for="pp_pp_category" class="form-label">Category</label>
        <select class="form-select form-select-sm" id="pp_pp_category" name="pp_pp_category" required>
          <option value="" disabled selected>Select category</option>
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
        </select>
      </div>
      <div class="col-md-4 d-flex align-items-end">
        <button type="submit" class="btn btn-success btn-sm w-100">
          <i class="uil uil-check-circle"></i> Save
        </button>
      </div>
    </div>
  </form>

  <!-- Plantilla List -->
  <div id="plantillaList" class="d-flex flex-column gap-2"></div>
  <div id="noPlantillaResults" class="d-none text-center p-2">No results found.</div>

</div>

<script>
  // Reusable function to filter plantilla list
  function filterPlantilla() {
    const searchValue = document.getElementById("searchPlantilla").value.toLowerCase().trim();
    const items = document.querySelectorAll(".plantilla-card");
    const noResults = document.getElementById("noPlantillaResults");

    let visibleCount = 0;

    items.forEach(item => {
      const name = item.querySelector(".pp_desc")?.textContent.toLowerCase() || "";
      const code = item.querySelector(".pp_code")?.textContent.toLowerCase() || "";

      if (name.includes(searchValue) || code.includes(searchValue)) {
        item.style.display = "flex"; // keep flex alignment
        visibleCount++;
      } else {
        item.style.display = "none";
      }
    });

    if (noResults) {
      noResults.classList.toggle("d-none", visibleCount > 0);
    }
  }

  // Add input listener for live search
  document.getElementById("searchPlantilla").addEventListener("input", filterPlantilla);

  // Fetch plantilla list
  function fetchPlantillaList() {
    const plantillaList = document.getElementById('plantillaList');
    if (!plantillaList) return;

    $.getJSON("<?= base_url('academic/getPlantillaList') ?>", function(data) {
      plantillaList.innerHTML = '';

      data.forEach(item => {
        const div = document.createElement('div');
        div.className = 'd-flex justify-content-between align-items-center p-2 mb-0 rounded shadow-sm border plantilla-card';
        div.dataset.id = item.pp_id;
        div.dataset.pp_desc = item.pp_desc;
        div.dataset.pp_rank = item.pp_rank;
        div.dataset.pp_code = item.pp_code;
        div.dataset.pp_category = item.pp_category;

        div.innerHTML = `
          <div class="d-flex align-items-center gap-2">
            <span class="badge bg-success fw-semibold d-flex justify-content-center align-items-center" 
                  style="font-size:0.55rem; width:18px; height:18px; border-radius:50%;">
              ${item.pp_rank}
            </span>

            <div class="d-flex flex-column">
              <span class="fw-medium pp_desc" style="font-size:0.85rem;">${item.pp_desc}</span>
              <small class="text-muted pp_code" style="font-size:0.75rem;">
                <i class="uil uil-list-ul"></i> (${item.pp_category})&nbsp;${item.pp_code}
              </small>
            </div>
          </div>
          <div class="d-flex align-items-center gap-3">
            ${item.updated_at ? `<small class="text-muted" style="font-size:0.7rem;">
              <i class="uil uil-clock"></i> ${item.updated_at}
            </small>` : ''}
            <i class="uil uil-trash-alt text-danger" style="cursor:pointer;" title="Delete"></i>
            <i class="uil uil-arrows-v text-secondary" style="cursor: grab;" title="Drag"></i>
          </div>
        `;
        plantillaList.appendChild(div);

        // Delete button
        div.querySelector('.uil-trash-alt').addEventListener('click', function(e) {
          e.stopPropagation();
          Swal.fire({
            title: 'Are you sure?',
            text: `Delete plantilla: ${item.pp_desc}?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
          }).then((result) => {
            if (result.isConfirmed) {
              $.post("<?= base_url('academic/deletePlantilla') ?>", { pp_id: item.pp_id }, function(res) {
                if (res.success) {
                  Swal.fire('Deleted!', 'Plantilla has been deleted.', 'success');
                  fetchPlantillaList(); // refresh list
                } else {
                  Swal.fire('Error', res.message || 'Could not delete plantilla.', 'error');
                }
              }, 'json');
            }
          });
        });

        // Click row to edit
        div.addEventListener('click', () => {
          const form = document.getElementById('plantillaPositionForm');
          form.classList.remove('d-none');
          form.reset();

          document.getElementById('pp_pp_id').value = item.pp_id;
          document.getElementById('pp_pp_desc').value = item.pp_desc;
          document.getElementById('pp_pp_rank').value = item.pp_rank;
          document.getElementById('pp_pp_code').value = item.pp_code;
          document.getElementById('pp_pp_category').value = item.pp_category;
        });
      });

      // Apply search filter after loading
      filterPlantilla();

      // Make list draggable
      new Sortable(plantillaList, {
        animation: 150,
        handle: '.uil-arrows-v',
        onEnd: function(evt) {
          const order = Array.from(plantillaList.children).map(c => c.dataset.id);
          $.post("<?= base_url('academic/savePlantillaOrder') ?>", { order: order }, function(res) {
            if (res.success) {
              Array.from(plantillaList.children).forEach((c, i) => {
                c.querySelector('.badge').textContent = i + 1;
              });
            } else {
              Swal.fire('Error', 'Could not save new order.', 'error');
            }
          }, 'json');
        }
      });
    });
  }

  // Initial fetch
  fetchPlantillaList();
</script>
